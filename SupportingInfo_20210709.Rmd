---
title: "Thunell DEBIPM Supporting info"
author: "Viktor Thunell"
date: '2021-07-09'
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("C:/Users/vitl0001/VThunell_repos/Temperature-DEBIPM")
```

## Supporting information for DEB IPM (temporary)

A1. Effects of size and temperature on maintenance, consumption and energy budget.

A2. Growth tarjectories and fecundity at for optimal allocation (kappa_0*)

A3. Fitness landscape & stable size structure for contrasting survival scenarios

A4. Optimal allocation strategy when kappa is fixed for in the first year of growth.


### A1. Effects of size and temperature on maintenance, consumption and energy budget 

#### Effects of temperature on maintenance and consumption 

Effects of temperature on maintenance and consumption 

```{r, echo = FALSE, warning = FALSE}
intake_E <- (eps1*x^eps2)*rI_T_GU2(GR_pars['T'],x)
E_bud <- bind_cols(Size=x, 
                   #Intake = (eps1*(x^eps2)*rI_T_GU2(GR_pars['T'],x)),
                   Assimilation = alpha*intake_E,
                   Maintenance =  rho1*x^rho2*rM_T_AL2(GR_pars['T'],x),
                   Growth =    kap_fun(x,GR_pars["kappa"])*alpha*intake_E - rho1*x^rho2*rM_T_AL2(GR_pars['T'],x),
                   Reserve = (1-kap_fun(x,GR_pars["kappa"]))*alpha*intake_E )

# EP_bud <- bind_cols(Size=x,
#                     Assimilation = 1-alpha,
#                     Maintenance =  rho1*x^rho2*rM_T_AL2(GR_pars['T'],x) / intake_E,
#                     Growth =  (kap_fun(x,GR_pars["kappa"])*alpha*intake_E - rho1*x^rho2*rM_T_AL2(GR_pars['T'],x)) / intake_E,
#                     Reserve = (1-kap_fun(x,GR_pars["kappa"]))*alpha)

E_bud_long <- pivot_longer(E_bud, cols = c(2:ncol(E_bud)), names_to = "comp", values_to = "gram")
E_bud_long$comp <- factor(E_bud_long$comp, levels=c( "Reserve", "Growth", "Maintenance", "Assimilation") )
# EP_bud_long <- pivot_longer(EP_bud, cols = c(2:ncol(E_bud)), names_to = "comp", values_to = "Proportion")
# EP_bud_long$comp <- factor(EP_bud_long$comp, levels=c( "Reserve", "Growth", "Maintenance", "Assimilation") )

Eb<-E_bud_long %>%
  ggplot() +
  geom_area(aes(Size, gram, fill = comp)) +
  coord_cartesian(xlim = c(min(x),max(x))) +
  scale_fill_brewer(palette="Dark2",name = "Compartment")+
  xlab("Size [g]" ) +
  ylab("Energy [g]" ) +
  theme_bw()

# EP_bud_long %>%
#   ggplot() +
#   geom_area(aes(Size, Proportion, fill = comp)) +
#   coord_cartesian(xlim = c(min(x),max(x))) +
#   scale_fill_brewer(palette="Dark2") +
#   theme_bw()  

### Plot Size functions 
Srate <- bind_cols(Size=x, 
                   Consumption=eps1*x^eps2,
                   Maintenance=rho1*x^rho2)
Srate_long <- pivot_longer(Srate, cols=c(2:3), names_to = "Rate", values_to = "Effect")

Sr<-Srate_long %>%
  ggplot() +
  geom_line(aes(Size, Effect, color = Rate), size=1) +
  scale_color_brewer(palette="Dark2") +
  scale_x_continuous(expand = c(0,0), name = "Size [gram]", limits = c(0,18000), breaks = seq(0,18000,5000)) +
  ylab("Effect [g/day]") +
  theme_bw() +
  theme(legend.position="none")

### Plot Temp functions 
Trate <- bind_cols(Temp=273:300, 
                   Consumption=rI_T_GU2(273:300, 10),
                   Maintenance=rM_T_AL2(273:300, 10))
Trate_long <- pivot_longer(Trate, cols=c(2:3), names_to = "Rate", values_to = "Effect")

Tr<-   Trate_long %>%
ggplot() +
  geom_line(aes(Temp, Effect, color = Rate), size=1) +
  scale_color_brewer(palette="Dark2") +
  scale_x_continuous(expand = c(0,0), name = "Temperature [K]", limits = c(274,300),breaks = seq(275,300,5))+
  ylab("")+
  theme_bw() 
  

(Sr + Tr) / Eb

```



#### Size dependent Kappa function (k(m), k_0=0.83, k_m=2 )

Size dependent Kappa function (k(m), k_0=0.83, k_m=2 )

```{r, echo = FALSE, warning = FALSE}
plot(x, kap_fun(x,kappa=0.83), xlab = "Weight", ylab = "kappa", type="l", ylim= c(0,1),main = "Size-dependent kappa")
lines(x, 1-kap_fun(x, kappa=0.83), ylab = "1-kappa", type="l", main = "Size-dependent 1-kappa", col="red")
legend("topright", c("Growth (kappa)", "Reproduction (1-kappa)"), lty=c(1,1), col = c("black" ,"red"),  cex=0.7)
```




#### Effects of temperature on size dependent energy budget

Effects of temperature on size dependent energy budget

```{r, echo = FALSE, warning = FALSE}
Temp <- seq(280, 300, 0.2)
GR_pars <- c(T = 287, 
             kappa = 0.83, 
             Y = 1)

T_rates2 <- NULL
for(i in Temp) {
  maint <- rho1*(x^rho2)*rM_T_AL2(i, x)
  intake  <- eps1*(x^eps2)*rI_T_GU2(i, x) 
  T_rates2 <- 
    rbind(T_rates2,cbind(Temp = i, mass = x, cIa = cIa,
                         maint, intake, 
                         growth_E = kap_fun(x,GR_pars["kappa"])*alpha*GR_pars["Y"]*intake - maint,
                         repro_E = alpha* GR_pars["Y"]*(1-kap_fun(x,GR_pars["kappa"]))*intake))
  }

T_rates <- T_rates2#rbind(T_rates2, T_rates1, T_rates0)
maxgT<- as.data.frame(T_rates) %>% 
        group_by(mass) %>%
        slice_max(0.35*(intake-maint))
#plot(maxgT$mass,maxgT$Temp,type="l")

T_rates_long <- pivot_longer(as.tibble(T_rates), 6:7, names_to = "E_type", values_to = "g_day")
T_rates_long["g_g_day"] <- T_rates_long$g_day/T_rates_long$mass


T_rates_long %>%
  filter(as.factor(mass) %in% c(T_rates_long$mass[c(5,50,100,400)])) %>%
  ggplot(.) +
    geom_line(size=1 , aes(Temp, g_day, color = as.factor(mass), 
                         linetype = as.factor(E_type))) +
#    facet_wrap(~cIa, labeller = label_both) +
    ylab("Energy budget, g/day") +
    ylim(0,NA)+
    #ylim(0,0.012) + #ylim(0,NA) +
    theme_bw() +
    scale_colour_brewer(palette="Dark2")

```




### A2. Growth trajectories and fecundity at for optimal allocation (kappa_0*)

Growth trajectories and fecundity at for optimal allocation (kappa_0*)

```{r, echo = FALSE, warning = FALSE}
groTopt+repTopt
```

Figure A2. Growth tarjectories (A) and fecundity (B) predicted from the optimal allocation strategy (k_0^*) at five temperatures and contrasted by growth and fecundity for k_0=0.83 (i.e. k_0 used in for tuning he model).

### A3. Fitness landscape & stable size structure for contrasting survival scenarios

Fitness landscape & stable size structure for contrasting survival scenarios

```{r, echo = FALSE, warning = FALSE}
Res_lam_2 <- read.delim("//storage-og.slu.se/home$/vitl0001/My Documents/Manus2/Results/Results0624/Res_lam_2_0624.txt", sep = ",")
maxl_2 <- as.data.frame(Res_lam_2) %>% 
  group_by(T) %>%
  slice_max(Lambda)
maxl_2["Sur_f"] <- "NotempVin"

FigA3a <- 
  as_tibble(Res_lam_2) %>%
  filter(kappa <= 1) %>%
  #mutate(kappa = kappa > 1) # set kappa > 1 to 1
  ggplot(., aes(T,kappa)) +
  geom_raster(aes(fill=round(Lambda, 4)))+#, interpolate = TRUE) +
  #geom_smooth(data=maxl_1 ,aes(T,kappa), size=0.85, se=FALSE) +
  #ggplot(., aes(T,kappa, z=round(Lambda, 4))) +#, color = as.factor(T))) +#, linetype = as.factor(kappa))) +
  # geom_contour_filled(breaks = 
  #                       c(0,seq(1,round(max(as_tibble(Res_lam)$Lambda),1),0.05),
  #                               max(as_tibble(Res_lam)$Lambda)))+
  geom_line(data=maxl_2 ,aes(T,kappa),size=0.85) +
  scale_fill_gradientn(
    limits = c(0,max(as.data.frame(Res_lam_2[,'Lambda'])+0.0001)),
    colours = c("black","white","yellow","red"),
    values = rescale(c(0,0.9999,1, round(max(as.data.frame(Res_lam_2[,'Lambda'])), 4)),
                     to=c(0,1)),
    breaks = c(0,1,round(max(as.data.frame(Res_lam_2[,'Lambda'])), 2)),
    labels=c("0",1,round(max(as.data.frame(Res_lam_2[,'Lambda'])),3)),
    name = expression(lambda)) +
  scale_x_continuous(expand = c(0,0), name = "Temperature [K]", limits = c(284,294),breaks = seq(285,293,2))+
  scale_y_continuous(expand = c(0,0), name=expression(paste(kappa," (Growth allocation)")), limits = c(0.6,1))+
  coord_cartesian(xlim = c(284,294)) +
  annotate(geom="text", -Inf, Inf, label="A", hjust = -26, vjust = 3, size= 4, fontface = "bold")+
  theme_bw()
#FigA3a

Res_w_2 <- read.delim("//storage-og.slu.se/home$/vitl0001/My Documents/Manus2/Results/Results0624/Res_w_2_0624.txt", sep = ",")
colnames(Res_w_2)[4:ncol(Res_w_2)] <- sub("X", "", colnames(Res_w_2)[4:ncol(Res_w_2)])

Res_w_2_long <- pivot_longer(as.data.frame(Res_w_2), cols = c(4:ncol(Res_w_2)), 
                           names_to = "Size", values_to ="biom") # not use column 4 & 5 (eggstage and recruits)

FigA3c_1 <- Res_w_2_long %>%
  filter(T %in% c(285, 287, 289, 291)) %>%
  filter(as.character(kappa) %in% 0.83) %>% #Floating point issue when comparing vector, therefore the use of %in%, can also use near()
  ggplot(., aes(as.numeric(Size), biom, group = rev(as.factor(T)), color = as.factor(T))) +
  geom_line(size=0.8)+
  ylab("Stable structure w")+
  xlab("Weight [g]")+
  ylim(0,6e-7)+
  annotate(geom="text", -Inf, Inf, label="C", hjust = -24, vjust = 2, size= 4, fontface = "bold") +
  scale_colour_brewer(palette="Dark2",name = "Temp [K]") +
  theme_bw() +
  labs(color = "Temp [K]")
#FigA3c_1

FigA3c_2 <- Res_w_2_long %>%
  filter(T %in% c(285, 287, 289, 291)) %>%
  filter(as.character(kappa) %in% 0.83) %>% #Floating point issue when comparing vector, therefore the use of %in%, can also use near()
  ggplot(., aes(as.numeric(Size), biom, group = rev(as.factor(T)), color = as.factor(T))) +
  geom_line(size=0.8)+
  ylab("Stable structure w")+
  xlab("Weight [g]")+
  ylim(0,5.5e-5)+
  scale_x_continuous(breaks = c(0,200,400), limits=c(0,400))+
  scale_colour_brewer(palette="Dark2",name = "Temp [K]") +
  theme_bw() +
  theme(legend.position="none",
        axis.title.x=element_blank(),
        plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
        axis.title.y=element_blank())
#FigA3c_2

mycolors <- rev(colorRampPalette(brewer.pal(9, "RdPu"))(9))
FigA3e <- 
  as_tibble(Res_w_2_long) %>%
  filter(kappa %in% 0.83) %>%
  mutate(biom_log=log(biom)) %>%
  ggplot(., aes(T,as.double(Size), z=biom_log, colour=biom_log))+
  geom_contour_filled(breaks = c(min(log(Res_w_2_long$biom)), #-12
                                seq(-25,-15,length.out = 7),
                                max(log(Res_w_2_long$biom))))+ #-160
  annotate(geom="text", -Inf, Inf, label="E", hjust = -24, vjust = 2, size= 4, fontface = "bold")+
  scale_fill_manual(values = rev(mycolors), name="Relative densities", 
                     labels=c(paste("< ",signif(exp(-25),5)), 
                              signif(seq(exp(-25),exp(-15),length.out = 6),5),
                              #expression("">=signif(max(Res_w_long$biom),5))))+
                              paste(">",signif(max(Res_w_2_long$biom),5)))) + 
  scale_x_continuous(expand = c(0,0), name = "Temperature [K]", limits = c(284,294),breaks = seq(285,293,2))+
  scale_y_continuous(expand = c(0,0), name = "Weight [g]", limits = c(0,18000))+
  coord_cartesian(xlim = c(284,294)) +
  theme_bw()
#FigA3e

Res_lam_3 <- read.delim("//storage-og.slu.se/home$/vitl0001/My Documents/Manus2/Results/Results0624/Res_lam_3_0624.txt", sep = ",")
maxl_3 <- as.data.frame(Res_lam_3) %>% 
  group_by(T) %>%
  slice_max(Lambda)
maxl_3["Sur_f"] <- "flat"

FigA3b <- 
  as_tibble(Res_lam_3) %>%
  filter(kappa <= 1) %>%
  #mutate(kappa = kappa > 1) # set kappa > 1 to 1
  ggplot(., aes(T,kappa)) +
  geom_raster(aes(fill=round(Lambda, 4)))+#, interpolate = TRUE) +
  #geom_smooth(data=maxl_1 ,aes(T,kappa), size=0.85, se=FALSE) +
  #ggplot(., aes(T,kappa, z=round(Lambda, 4))) +#, color = as.factor(T))) +#, linetype = as.factor(kappa))) +
  # geom_contour_filled(breaks = 
  #                       c(0,seq(1,round(max(as_tibble(Res_lam)$Lambda),1),0.05),
  #                               max(as_tibble(Res_lam)$Lambda)))+
  geom_line(data=maxl_3 ,aes(T,kappa),size=0.85) +
  scale_fill_gradientn(
    limits = c(0,max(as.data.frame(Res_lam_3[,'Lambda'])+0.0001)),
    colours = c("black","white","yellow","red"),
    values = rescale(c(0,0.9999,1, round(max(as.data.frame(Res_lam_3[,'Lambda'])), 4)),
                     to=c(0,1)),
    breaks = c(0,1,round(max(as.data.frame(Res_lam_3[,'Lambda'])), 2)),
    labels=c("0",1,round(max(as.data.frame(Res_lam_3[,'Lambda'])),3)),
    name = expression(lambda)) +
  scale_x_continuous(expand = c(0,0), name = "Temperature [K]", limits = c(284,294),breaks = seq(285,293,2))+
  scale_y_continuous(expand = c(0,0), name=expression(paste(kappa," (Growth allocation)")), limits = c(0.6,1))+
  coord_cartesian(xlim = c(284,294)) +
  annotate(geom="text", -Inf, Inf, label="B", hjust = -26, vjust = 3, size= 4, fontface = "bold")+
  theme_bw()
#FigA3b

# a=0.68, i.e flat survival scenario
Res_w_3 <- read.delim("//storage-og.slu.se/home$/vitl0001/My Documents/Manus2/Results/Results0624/Res_w_3_0624.txt", sep = ",")
colnames(Res_w_3)[4:ncol(Res_w_3)] <- sub("X", "", colnames(Res_w_3)[4:ncol(Res_w_3)])

Res_w_3_long <- pivot_longer(as.data.frame(Res_w_3), cols = c(4:ncol(Res_w_3)), 
                           names_to = "Size", values_to ="biom") # not use column 4 & 5 (eggstage and recruits)

FigA3d_1 <- Res_w_3_long %>%
  filter(T %in% c(285, 287, 289, 291)) %>%
  filter(as.character(kappa) %in% 0.83) %>% #Floating point issue when comparing vector, therefore the use of %in%, can also use near()
  ggplot(., aes(as.numeric(Size), biom, group = rev(as.factor(T)), color = as.factor(T))) +
  geom_line(size=0.8)+
  ylab("Stable structure w")+
  xlab("Weight [g]")+
  ylim(0,6e-6)+
  annotate(geom="text", -Inf, Inf, label="D", hjust = -24, vjust = 2, size= 4, fontface = "bold") +
  scale_colour_brewer(palette="Dark2",name = "Temp [K]") +
  theme_bw() +
  labs(color = "Temp [K]")
#FigA3d_1

FigA3d_2 <- Res_w_3_long %>%
  filter(T %in% c(285, 287, 289, 291)) %>%
  filter(as.character(kappa) %in% 0.83) %>% #Floating point issue when comparing vector, therefore the use of %in%, can also use near()
  ggplot(., aes(as.numeric(Size), biom, group = rev(as.factor(T)), color = as.factor(T))) +
  geom_line(size=0.8)+
  ylab("Stable structure w")+
  xlab("Weight [g]")+
  ylim(0,5.5e-5)+
  scale_x_continuous(breaks = c(0,200,400), limits=c(0,400))+
  scale_colour_brewer(palette="Dark2",name = "Temp [K]") +
  theme_bw() +
  theme(legend.position="none",
        axis.title.x=element_blank(),
        plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
        axis.title.y=element_blank())
#FigA3d_2

mycolors <- rev(colorRampPalette(brewer.pal(9, "RdPu"))(9))
FigA3f <- 
  as_tibble(Res_w_3_long) %>%
  filter(kappa %in% 0.83) %>%
  mutate(biom_log=log(biom)) %>%
  ggplot(., aes(T,as.double(Size), z=biom_log, colour=biom_log))+
  geom_contour_filled(breaks = c(min(log(Res_w_3_long$biom)), #-12
                                seq(-25,-15,length.out = 7),
                                max(log(Res_w_3_long$biom))))+ #-160
  annotate(geom="text", -Inf, Inf, label="F", hjust = -24, vjust = 2, size= 4, fontface = "bold")+
  scale_fill_manual(values = rev(mycolors), name="Relative densities", 
                     labels=c(paste("< ",signif(exp(-25),5)), 
                              signif(seq(exp(-25),exp(-15),length.out = 6),5),
                              #expression("">=signif(max(Res_w_long$biom),5))))+
                              paste(">",signif(max(Res_w_3_long$biom),5)))) + 
  scale_x_continuous(expand = c(0,0), name = "Temperature [K]", limits = c(284,294),breaks = seq(285,293,2))+
  scale_y_continuous(expand = c(0,0), name = "Weight [g]", limits = c(0,18000))+
  coord_cartesian(xlim = c(284,294)) +
  theme_bw()
#FigA3f


#subvp <- viewport(width = 0.17, height = 0.2, x = 0.28, y = 0.52)
#subvp2 <- viewport(width = 0.17, height = 0.2, x = 0.78, y = 0.52)
subvp <- viewport(width = 0.15, height = 0.18, x = 0.2, y = 0.55)
subvp2 <- viewport(width = 0.15, height = 0.18, x = 0.7, y = 0.55)

(FigA3a/FigA3c_1/FigA3e) | (FigA3b/FigA3d_1/FigA3f)
print(FigA3c_2, vp = subvp)
print(FigA3d_2, vp = subvp2)


```

Figure A3. Fitness landscape (A,B) with solid line representing optimal allocation strategy (k_0*) and stable structure w for four temperatures (C,D) and over temperature (E,F) for survival contrast a(x)(A,C,E) and a=0.68 (B,D,F).




### A4. Optimal allocation strategy when kappa is fixed for in the first year of growth.

By setting kappa to 1 in the vital rate function descriing first year growth (DEBage1.size), we see that optimal allocation can be substantially lower. 


```{r, echo = FALSE, warning = FALSE}

Res_lam_A1 <- read.delim("//storage-og.slu.se/home$/vitl0001/My Documents/Manus2/Results/Results0709/Res_lam_5_0709.txt", sep = ",")

maxl_5 <- as.data.frame(Res_lam_A1) %>% 
  group_by(T) %>%
  slice_max(Lambda)

FigA4 <- 
  as_tibble(Res_lam_A1) %>%
  filter(kappa <= 1) %>%
  #mutate(kappa = kappa > 1) # set kappa > 1 to 1
  ggplot(., aes(T,kappa)) +
  geom_raster(aes(fill=round(Lambda, 4)))+#, interpolate = TRUE) +
  #geom_smooth(data=maxl_1 ,aes(T,kappa), size=0.85, se=FALSE) +
  #ggplot(., aes(T,kappa, z=round(Lambda, 4))) +#, color = as.factor(T))) +#, linetype = as.factor(kappa))) +
  # geom_contour_filled(breaks = 
  #                       c(0,seq(1,round(max(as_tibble(Res_lam)$Lambda),1),0.05),
  #                               max(as_tibble(Res_lam)$Lambda)))+
  geom_line(data=maxl_5 ,aes(T,kappa),size=0.85) +
  scale_fill_gradientn(
    limits = c(0,max(as.data.frame(Res_lam_A1[,'Lambda'])+0.0001)),
    colours = c("black","white","yellow","red"),
    values = rescale(c(0,0.9999,1, round(max(as.data.frame(Res_lam_A1[,'Lambda'])), 4)),
                     to=c(0,1)),
    breaks = c(0,1,round(max(as.data.frame(Res_lam_A1[,'Lambda'])), 2)),
    labels=c("0",1,round(max(as.data.frame(Res_lam_A1[,'Lambda'])),3)),
    name = expression(lambda)) +
  scale_x_continuous(expand = c(0,0), name = "Temperature [K]", limits = c(284,294),breaks = seq(285,293,2))+
  scale_y_continuous(expand = c(0,0), name=expression(paste(kappa," (Growth allocation)")), limits = c(0.6,1))+
  coord_cartesian(xlim = c(284,294)) +
  #annotate(geom="text", -Inf, Inf, label="A", hjust = -26, vjust = 3, size= 4, fontface = "bold")+
  theme_bw()
FigA4



```
